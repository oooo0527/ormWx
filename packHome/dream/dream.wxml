<global-background>
  <custom-navbar title="ormkornnaphat" showBack="{{true}}" showHome="{{false}}"></custom-navbar>
  <view class="container" style="margin-top: {{navBarHeight}}px;min-height:calc(100vh - {{navBarHeight}}px);">
    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <view class="tabs" style="top: {{navBarHeight}}px;">
      <view class="tab-item {{activeTab === 'ranking' ? 'active' : ''}}" data-tab="ranking" bindtap="switchTab">
        <text>æ’è¡Œæ¦œ</text>
      </view>
      <view class="tab-item {{activeTab === 'photos' ? 'active' : ''}}" data-tab="photos" bindtap="switchTab">
        <text>é£æ ¼ç…§ç‰‡</text>
      </view>
      <view class="tab-item {{activeTab === 'submit' ? 'active' : ''}}" data-tab="submit" bindtap="switchTab">
        <text>æˆ‘è¦æŠ•ç¨¿</text>
      </view>
      <view class="tab-item {{activeTab === 'myphotos' ? 'active' : ''}}" data-tab="myphotos" bindtap="switchTab">
        <text>æˆ‘çš„æŠ•ç¨¿</text>
      </view>
    </view>
    <!-- æ’è¡Œæ¦œå†…å®¹ -->
    <view class="content" wx:if="{{activeTab === 'ranking'}}">
      <!-- å‰ä¸‰åå±•ç¤ºåŒºåŸŸ -->
      <view class="top-three-container" wx:if="{{topThreeList.length > 0}}">
        <view class="top-three-content">
          <!-- ç¬¬äºŒå -->
          <view class="top-item second-place" wx:if="{{topThreeList.length > 1}}" bindtap="showModal" data-index="1">
            <view class="medal">ğŸ¥ˆ</view>
            <image class="top-avatar" src="{{topThreeList[1].userAvatar}}" mode="aspectFill"></image>
            <view class="top-info">
              <text class="top-name">{{topThreeList[1].userName}}</text>
              <text class="top-likes">{{topThreeList[1].likes}} ç‚¹èµ</text>
            </view>
          </view>
          <!-- ç¬¬ä¸€å -->
          <view class="top-item first-place" wx:if="{{topThreeList.length > 0}}" bindtap="showModal" data-index="0">
            <view class="medal">ğŸ¥‡</view>
            <image class="top-avatar" src="{{topThreeList[0].userAvatar}}" mode="aspectFill"></image>
            <view class="top-info">
              <text class="top-name">{{topThreeList[0].userName}}</text>
              <text class="top-likes">{{topThreeList[0].likes}} ç‚¹èµ</text>
            </view>
          </view>
          <!-- ç¬¬ä¸‰å -->
          <view class="top-item third-place" wx:if="{{topThreeList.length > 2}}" bindtap="showModal" data-index="2">
            <view class="medal">ğŸ¥‰</view>
            <image class="top-avatar" src="{{topThreeList[2].userAvatar}}" mode="aspectFill"></image>
            <view class="top-info">
              <text class="top-name">{{topThreeList[2].userName}}</text>
              <text class="top-likes">{{topThreeList[2].likes}} ç‚¹èµ</text>
            </view>
          </view>
        </view>
      </view>
      <view class="ranking-list">
        <view class="list-header">
          <text class="header-rank">æ’å</text>
          <text class="header-user">ç”¨æˆ·</text>
          <text class="header-score">ç‚¹èµ</text>
          <text class="header-photos">ç…§ç‰‡</text>
        </view>
        <block wx:for="{{rankingList}}" wx:key="_id" wx:for-index="index" wx:for-item="item">
          <!-- ä»ç¬¬4åå¼€å§‹æ˜¾ç¤º -->
          <view wx:if="{{index >= 3}}" class="ranking-item" bindtap="showModal" data-index="{{index}}">
            <view class="rank-number">
              <text>{{index + 1}}</text>
            </view>
            <view class="user-info">
              <image class="user-avatar" src="{{item.userAvatar}}" mode="aspectFill"></image>
              <text class="user-name">{{item.userName}}</text>
            </view>
            <text class="score">{{item.likes}}</text>
            <view class="photos-contens">
              <image class="photos-count" src="{{item.imageUrl}}" mode="widthFix" lazy-load="{{true}}"></image>
            </view>
          </view>
        </block>
        <view wx:if="{{rankingList.length === 0}}" class="empty-state">
          <text>æš‚æ— æ’è¡Œæ¦œæ•°æ®</text>
        </view>
      </view>
    </view>
    <!-- æ’è¡Œæ¦œè¯¦æƒ…å¼¹çª— -->
    <view class="ranking-modal {{showModal ? 'show' : ''}}" bindtap="hideModal">
      <view class="modal-content" catchtap="preventTap">
        <view class="modal-header">
          <text class="modal-title">æ’è¡Œæ¦œè¯¦æƒ…</text>
          <view class="close-btn" bindtap="hideModal">Ã—</view>
        </view>
        <view class="modal-body" wx:if="{{selectedItem}}">
          <view class="user-info-section">
            <image class="modal-user-avatar" src="{{selectedItem.userAvatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
            <view class="user-details">
              <text class="modal-user-name">{{selectedItem.userName || 'æœªçŸ¥ç”¨æˆ·'}}</text>
              <text class="modal-rank">æ’å: {{selectedItem.rank}}</text>
            </view>
          </view>
          <view class="photo-section">
            <image class="modal-photo" src="{{selectedItem.imageUrl}}" mode="widthFix" bindtap="viewPhotoInModal"></image>
          </view>
          <view class="stats-section">
            <view class="stat-item">
              <text class="stat-label">ç‚¹èµæ•°</text>
              <text class="stat-value">{{selectedItem.likes || 0}}</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">é£æ ¼</text>
              <text class="stat-value">{{selectedItem.style || 'æœªåˆ†ç±»'}}</text>
            </view>
          </view>
          <view class="description-section">
            <text class="description-label">æè¿°:</text>
            <text class="description-text">{{selectedItem.description || 'æš‚æ— æè¿°'}}</text>
          </view>
          <view class="action-section">
            <button class="like-btn {{likedPhotoIds.includes(selectedItem._id) ? 'liked' : ''}}" bindtap="likePhotoInModal">
              {{likedPhotoIds.includes(selectedItem._id) ? 'å·²ç‚¹èµ' : 'ç‚¹èµ'}}
            </button>
          </view>
        </view>
      </view>
    </view>
    <!-- é£æ ¼ç…§ç‰‡å†…å®¹ -->
    <view class="content" wx:if="{{activeTab === 'photos'}}">
      <view class="style-groups">
        <block wx:for="{{groupedPhotos}}" wx:for-item="photos" wx:for-index="style" wx:key="style">
          <view class="style-group">
            <image src="{{groupedPhotos[style][0].imageUrl}}" mode="aspectFill" class="style-group-img" />
            <view class="style-header" bindtap="viewStyleDetail" data-style="{{style}}">
              <text class="style-title">{{style}}</text>
              <text>{{groupedPhotos[style].length}}å¼ </text>
            </view>
          </view>
        </block>
        <view wx:if="{{Object.keys(groupedPhotos).length === 0}}" class="empty-state">
          <text>æš‚æ— å®¡æ ¸é€šè¿‡çš„ç…§ç‰‡</text>
        </view>
      </view>
      <!-- åº•éƒ¨è£…é¥° -->
      <view class="bottom-decoration">
        <text class="school-motto">çŸ¥è¯†æ”¹å˜å‘½è¿ï¼Œå­¦ä¹ æˆå°±æœªæ¥</text>
      </view>
    </view>
    <!-- æŠ•ç¨¿å†…å®¹ -->
    <view class="content" wx:if="{{activeTab === 'submit'}}">
      <view class="submit-form">
        <view class="form-section">
          <text class="section-title">é€‰æ‹©é£æ ¼</text>
          <view class="style-options">
            <block wx:for="{{styleOptions}}" wx:key="index">
              <view class="style-option {{submissionForm.style === item ? 'selected' : ''}}" data-style="{{item}}" bindtap="selectStyle">
                <text>{{item}}</text>
              </view>
            </block>
          </view>
        </view>
        <view class="form-section">
          <text class="section-title">ä¸Šä¼ ç…§ç‰‡</text>
          <view class="upload-section" bindtap="chooseImage">
            <view wx:if="{{!submissionForm.image}}" class="upload-placeholder">
              <text>ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</text>
            </view>
            <image wx:if="{{submissionForm.image}}" class="uploaded-image" src="{{submissionForm.image}}" mode="aspectFill"></image>
          </view>
        </view>
        <view class="form-section">
          <text class="section-title">ç…§ç‰‡æè¿°</text>
          <textarea class="description-input" placeholder="è¯·è¾“å…¥ç…§ç‰‡æè¿°..." value="{{submissionForm.description}}" bindinput="inputDescription" maxlength="10"></textarea>
        </view>
        <view class="cooldown-info" wx:if="{{false}}">
          <text>æ‚¨ä»Šå¤©å·²æŠ•ç¨¿ï¼Œè¯·æ˜å¤©å†æ¥</text>
        </view>
        <button class="submit-btn" bindtap="submitPhoto">
          {{canSubmit && userInfo ? 'æäº¤æŠ•ç¨¿' : (userInfo ? 'ä»Šæ—¥å·²æŠ•ç¨¿' : 'è¯·å…ˆç™»å½•')}}
        </button>
      </view>
    </view>
    <!-- æˆ‘çš„æŠ•ç¨¿å†…å®¹ -->
    <view class="content" wx:if="{{activeTab === 'myphotos'}}">
      <view class="my-photos-list">
        <view wx:if="{{userPhotos.length === 0}}" class="empty-state">
          <text>æ‚¨è¿˜æ²¡æœ‰æŠ•ç¨¿ä»»ä½•ç…§ç‰‡</text>
        </view>
        <view class="waterfall-container">
          <block wx:for="{{userPhotos}}" wx:key="_id">
            <view class="photo-card">
              <image class="photo-img" src="{{item.imageUrl}}" mode="aspectFill" bindtap="viewPhoto" data-image="{{item.imageUrl}}"></image>
              <view class="photo-details">
                <view class="photo-meta">
                  <view class="photo-style">é£æ ¼ï¼š{{item.style}}</view>
                  <view class="photo-status {{item.status === 'approved' ? 'status-approved' : (item.status === 'pending' ? 'status-pending' : 'status-rejected')}}">
                    {{item.status === 'approved' ? 'å·²é€šè¿‡' : (item.status === 'pending' ? 'å®¡æ ¸ä¸­' : 'å·²æ‹’ç»')}}
                  </view>
                </view>
                <text class="photo-desc">{{item.description}}</text>
                <text class="photo-time" wx-if="{{item.status != 'approved' && item.status != 'pending'}}">
                  æ‹’ç»åŸå› ï¼š{{item.rejectionReason}}
                </text>
                <button class="action-btn delete-btn" bindtap="deletePhoto" data-id="{{item._id}}">
                  åˆ é™¤
                </button>
              </view>
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>
</global-background>