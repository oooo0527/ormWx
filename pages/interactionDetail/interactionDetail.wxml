<global-background>
  <custom-navbar title="ormkornnaphat" showBack="{{true}}" showHome="{{false}}"></custom-navbar>
  <view class="container" style="margin-top: {{navBarHeight}}px;min-height:calc(100vh - {{navBarHeight}}px);">
    <view class="carousel-container1">
      <image src="{{works.images[0]}}" mode="aspectFill" class="selected-work-image" wx:show="{{works.images.length>0}}" lazy-load></image>
      <view class="selected-work-detail">
        <image src="{{works.images[0]}}" class="swiper-image" mode="widthFix" wx:if="{{works.images.length>0}}" lazy-load bindtap="onSwiperImageTap"></image>
        <view class="selected-work-title">{{works.title}}</view>
        <view class="selected-work-description">{{works.content}}</view>
        <!-- 收藏按钮 -->
        <view class="favorite-section">
          <button class="favorite-btn" bindtap="toggleFavorite">
            <text wx:if="{{isFavorited}}">★ 已收藏</text>
            <text wx:else>☆ 收藏</text>
          </button>
        </view>
      </view>
    </view>
    <!-- 评论区域 -->
    <view class="comments-section">
      <view class="section-title">评论 ({{comments.length}})</view>
      <!-- 评论输入区域 -->
      <view class="comment-input-area">
        <textarea class="comment-textarea" placeholder="请输入评论内容..." value="{{newComment}}" bindinput="onCommentInput"></textarea>
        <button class="submit-comment-btn" bindtap="submitComment">奥</button>
      </view>
      <!-- 评论列表 -->
      <view class="comments-list">
        <block wx:for="{{comments}}" wx:key="index">
          <view class="comment-item" id="comment-{{item.commentId}}" style="{{highlightCommentId === item.commentId ? 'animation: highlightAnimation 3s ease-in-out;' : ''}}">
            <!-- 评论者信息 -->
            <view class="comment-header">
              <image class="comment-avatar" src="{{item.userInfo.avatar}}"></image>
              <view class="comment-Box">
                <view class="comment-user-info">
                  <text class="comment-nickname">{{item.userInfo.nickname}}</text>
                  <text class="comment-text">{{item.content}}</text>
                </view>
                <!-- 评论内容 -->
                <view class="comment-content">
                  <view class="comment-time">{{item.createDate}} {{item.createTime}}</view>
                  <view class="reply-text" bindtap="startReply" data-id="{{item.commentId}}" data-nickname="{{item.userInfo.nickname}}" data-index="{{index}}">
                    回复
                  </view>
                </view>
              </view>
            </view>
            <!-- 回复输入区域 (当前评论专用) -->
            <view class="reply-input-area" wx:if="{{replyingToIndex === index}}">
              <view class="reply-to">回复 @{{item.userInfo.nickname}}:</view>
              <textarea class="reply-textarea" placeholder="请输入回复内容..." value="{{newReply}}" bindinput="onReplyInput"></textarea>
              <view class="reply-actions">
                <button class="cancel-btn" bindtap="cancelReply">取消</button>
                <button class="submit-btn" bindtap="submitReply" data-comment-id="{{item.commentId}}" data-index="{{index}}">
                  发送
                </button>
              </view>
            </view>
            <!-- 回复列表 -->
            <view class="replies-list" wx:if="{{item.replies && item.replies.length > 0}}">
              <!-- 回复项列表 -->
              <block wx:for="{{item.replies}}" wx:for-item="replyItem" wx:for-index="replyIndex" wx:key="index">
                <!-- 如果回复数超过3条且未展开，则只显示前3条 -->
                <view wx:if="{{expandedReplies[index] || replyIndex < 3}}">
                  <view class="reply-item" id="reply-{{replyItem.replyId || replyItem.id}}" style="{{highlightReplyId === (replyItem.replyId || replyItem.id) ? 'animation: highlightAnimation 3s ease-in-out;' : ''}}">
                    <view class="reply-header">
                      <image class="reply-avatar" src="{{replyItem.userInfo.avatar}}" wx:if="{{replyItem.userInfo.avatar}}"></image>
                      <image class="reply-avatar" src="/images/default-avatar.png" wx:else></image>
                    </view>
                    <view class="reply-content">
                      <view class="reply-user-info">
                        <text class="reply-nickname">{{replyItem.userInfo.nickname}}</text>
                        <text>{{replyItem.content}}</text>
                      </view>
                      <view class="reply-actions">
                        <view class="reply-time">
                          {{replyItem.createDate}} {{replyItem.createTime}}
                        </view>
                        <view class="reply-text2" bindtap="startReply1" data-id="{{replyItem.id}}" data-nickname="{{replyItem.userInfo.nickname}}" data-index="{{index}}" data-reply-index="{{replyIndex}}">
                          回复
                        </view>
                      </view>
                    </view>
                  </view>
                  <!-- 回复的回复输入区域 (当前回复专用) -->
                  <view class="reply-to-reply-input-area" wx:if="{{replyingToReplyIndex === replyIndex && replyingToCommentIndex === index}}">
                    <view class="reply-to">回复 @{{replyItem.userInfo.nickname}}:</view>
                    <textarea class="reply-textarea" placeholder="请输入回复内容..." value="{{newReplyToReply}}" bindinput="onReplyToReplyInput"></textarea>
                    <view class="reply-actions">
                      <button class="cancel-btn" bindtap="cancelReplyToReply">取消</button>
                      <button class="submit-btn" bindtap="submitReplyToReply" data-comment-id="{{item.commentId}}" data-reply-id="{{replyItem.id}}" data-comment-index="{{index}}" data-reply-index="{{replyIndex}}">
                        发送
                      </button>
                    </view>
                  </view>
                </view>
              </block>
              <!-- 展开/收起按钮放在底部 -->
              <view class="toggle-replies" bindtap="toggleReplies" data-comment-index="{{index}}">
                <text wx:if="{{expandedReplies[index]}}">收起回复</text>
                <text wx:else>展开回复 ({{item.replies.length}}条)</text>
              </view>
            </view>
          </view>
        </block>
      </view>
    </view>
  </view>
</global-background>